Отлично. Ниже — «пересобранная» дорожная карта: компактнее, без потерь по сути, с единым шаблоном для этапов (Цель → Решения/инструменты → Чек-лист → Готово когда → Артефакты) и с готовыми стартовыми сниппетами (CSP, chi, миграции, sqlc, Makefile, OpenAPI-рыба).

---

# Этап 0 — Цели и NFR

**Цель.** Зафиксировать рамки, чтобы все последующие решения были согласованы.
**Решения.** MVP: `/, /catalog, /catalog/{sku}, cart, order, /admin` (просто). SSR, без SPA. MSQL. EUR, `Europe/Helsinki`. Доступность 99.9%+, P95: HTML < 200 мс (локально), API < 150 мс. RPS — целевое значение X (задать). Логи JSON + Prometheus. i18n (ru/fi) — позже.
**Чек-лист.** ADR записан; README/ARCHITECTURE.md созданы.
**Готово когда.** Есть `ADR-0001-nfr.md`, `README.md`, `ARCHITECTURE.md`.
**Артефакты.** ADR, README, ARCHITECTURE.

---

# Этап 1 — Каркас проекта

**Цель.** Скaffold, который стартует и логично раскладывает слои.
**Решения.** Go 1.22+, `golangci-lint`. Структура:

```
cmd/app/
internal/{http,view,config,platform,domain,service,repo}
web/{templates,assets}
migrations/
api/
```

**Чек-лист.** `go.mod`, `internal/config` (env→Config), `internal/platform/server.go` с таймаутами и `MaxHeaderBytes`. Линтеры (errcheck, govet, staticcheck).
**Готово когда.** `go run ./cmd/app` даёт `/`, `/healthz`, `/assets/*`.
**Артефакты.** Базовый main, сервер, конфиг, линтер-конфиг.

---

# Этап 2 — HTTP (chi) + базовая защита

**Цель.** Предсказуемый HTTP-слой с безопасными дефолтами.
**Инструменты.** `github.com/go-chi/chi/v5`, `chi/middleware`, `go-chi/httprate`, `justinas/nosurf`, `go-chi/cors`(при необходимости).
**Чек-лист.** RequestID, RealIP, Recoverer, Timeout(15s), Logger, Compress; заголовки безопасности (CSP, HSTS, X-CTO, X-Frame-Options, Referrer-Policy); `/readyz`, `/metrics` (пока закрыт), rate-limit на мутирующие.
**Готово когда.** Все мидлвары стоят, health/ready работают, лимиты включены.
**Артефакты.** HTTP-роутер, middlewares.


---

# Этап 3 — Views (SSR) и статика

**Цель.** Рендер HTML с layout/partials и корректными кэш-заголовками.
**Решения.** `html/template`, общий `ViewModel`, форматтеры денег/дат (FI/RU). Статика — `Cache-Control`, `ETag`, далее — хеши в именах.
**Чек-лист.** Базовый layout + `home`, `catalog`, `product`, partials (`card`, `nav`, `footer`). Авто-эскейпинг, без `template.HTML` (кроме whitelisted мест).
**Готово когда.** Страницы рендерятся на моках; статика кэшируется.
**Артефакты.** Шаблоны, helper-функции.

---

# Этап 4 — Доменная модель

**Цель.** Чёткие сущности и инварианты.
**Решения.** Деньги: `int64 price_cents` + `currency="EUR"`. Уникальный `sku`, `qty>=1`, `price>=0`.
**Чек-лист.** ADR с перечислением сущностей/полей и инвариантов.
**Готово когда.** `ADR-0002-domain-model.md` в репо.
**Артефакты.** Domain-структуры в `internal/domain`.

---

# Этап 5 — Схема БД и миграции

**Цель.** Реплицируемая схема + индексы и проверки.
**Инструменты.** `golang-migrate/migrate/v4`.
**Чек-лист.** `0001_init.sql` с таблицами/индексами/FK/ CHECK; rollback-стратегия.
**Готово когда.** `migrate up` на чистой БД проходит.
**Артефакты.** SQL-миграции.

**Сниппет `migrations/0001_init.sql` (фрагмент):**


---

# Этап 6 — Доступ к данным (sqlc)

**Цель.** Типобезопасный доступ к БД с явным SQL.
**Инструменты.** `pgx/v5/stdlib`, `sqlc`. Пулы: `MaxOpen/MaxIdle/ConnMaxLifetime`.
**Чек-лист.** `internal/repo/sqlc`, `queries.sql`, `sqlc.yaml`, интерфейсы `repo.Product`, `repo.Order`, контекст везде.
**Готово когда.** `Product.List/ByID/Create` есть + интеграционный тест.
**Артефакты.** Сгенерированный код sqlc, адаптеры интерфейсов.

# Этап 7 — Сервисы (бизнес-логика)

**Цель.** Отделить доменную логику от HTTP/БД (DI).
**Решения.** `CatalogService`, `CartService`, `OrderService`, `AuthService`; транзакции через `WithinTx(ctx, fn)`. Денежная арифметика централизована.
**Чек-лист.** Табличные юнит-тесты на ключевые ветки.
**Готово когда.** Сервисы покрыты тестами, не импортируют HTTP.
**Артефакты.** `internal/service/*`.

---

# Этап 8 — API (JSON) и контракты

**Цель.** Стабильные HTTP-контракты с генерацией.
**Инструменты.** OpenAPI (spec-first) + `oapi-codegen` (kin-openapi) **или** `swaggo` (code-first).
**Чек-лист.** `/api/v1/products`, `/api/v1/products/{id}`, пагинация/сортировка/фильтры; единый формат ошибок; сгенерённая спецификация.
**Готово когда.** Контрактные тесты проходят; `httptest` покрывает хендлеры.
**Артефакты.** `api/openapi.yaml`, генерация клиента/серверных интерфейсов.

**ошибок:**

```json
{ "error": { "code": "VALIDATION_FAILED", "message": "Invalid input", "fields": { "price": "must be > 0" } } }
```

---

# Этап 9 — Аутентификация и сессии

**Цель.** Надёжные сессии для SSR и токены для API.
**Инструменты.** Web: `alexedwards/scs/v2`, `nosurf`; пароли: `alexedwards/argon2id` или `bcrypt`; API: `golang-jwt/jwt/v5`.
**Чек-лист.** Регистрация/логин/логаут/сброс пароля/верификация email; роли (`admin`, `editor`, `customer`), защита `/admin`; Cookie: `Secure`, `HttpOnly`, `SameSite`.
**Готово когда.** `/admin` виден только после логина с нужной ролью.
**Артефакты.** Мидлвари и хендлеры аутентификации.

---

# Этап 10 — Наблюдаемость

**Цель.** Видимость RPS/латентности/ошибок/трейсов.
**Инструменты.** `log/slog` (JSON), `promhttp`, OpenTelemetry (Jaeger/Tempo).
**Чек-лист.** `/metrics` экспортит базовые/кастомные метрики по роутам; спаны HTTP/DB с propagation.
**Готово когда.** Метрики и трейсы видны в стеке мониторинга.
**Артефакты.** Логгер-обёртки, регистры метрик, OTEL-инициализация.

---

# Этап 11 — Производительность и устойчивость

**Цель.** Вписаться в NFR с запасом.
**Решения.** `pprof` (dev), лимиты пулов БД, EXPLAIN/ANALYZE, Redis-кэш (сессии/тяжёлые чтения), keyset-пагинация.
**Чек-лист.** Нет N+1; бенч-тесты `testing.B` на критичных местах.
**Готово когда.** P95 укладывается на тестовом профиле нагрузки.
**Артефакты.** Скрипты нагрузочного теста, отчёт.

---

# Этап 12 — Фоновые задачи и интеграции

**Цель.** Надёжные отложенные операции.
**Инструменты.** `hibiken/asynq`, паттерн Outbox.
**Чек-лист.** Ретраи (экспоненциально), идемпотентность (ключи), обработка вебхуков.
**Готово когда.** Повторы не ломают инварианты; задачи восстанавливаются после падений.
**Артефакты.** Воркеры, outbox-таблица.

---

# Этап 13 — Безопасность (углубление)

**Цель.** Свести риски к минимуму.
**Решения.** TLS/ACME за прокси (nginx/Traefik), валидация `validator/v10`, загрузки с верификацией, brute-force защита, секреты из env/Secret Store, SBOM (Syft), сканы (`govulncheck`, `trivy`).
**Чек-лист.** Регулярные сканы CI; threat-model для логина/платежей/админки.
**Готово когда.** Отчёты чистые; ремедиации задокументированы.
**Артефакты.** CI-пайплайн, threat-model doc.

---

# Этап 14 — Платежи (опционально)

**Цель.** Идемпотентные платежи с корректным учётом.
**Решения.** `Idempotency-Key` на POST, проверенные вебхуки (подпись/повторы), простая «книга» операций.
**Чек-лист.** Тестовые сценарии провайдера проходят; двойных списаний нет.
**Готово когда.** QA-чек на happy/edge-cases зелёный.
**Артефакты.** Интеграционные тесты, вебхук-верификация.

---

# Этап 15 — Локализация и SEO

**Цель.** RU/FI и базовая SEO-санитация.
**Решения.** `internal/view/i18n` (map по локали) или gettext; выбор языка (Accept-Language/param/cookie); SEO-теги, sitemap/robots, слаги.
**Чек-лист.** Формат дат/денег по локали; канонические URL.
**Готово когда.** Страницы валидируются линтерами SEO, переключение локали работает.
**Артефакты.** i18n-ресурсы, sitemap/robots.

---

# Этап 16 — Тестирование (стратегия)

**Цель.** Предсказуемое качество.
**Инструменты.** `stretchr/testify`, `testcontainers-go`/`dockertest`, e2e — Playwright/Cypress (опционально).
**Пирамида.** Юнит → Интеграция (repo+миграции) → Контракты (OpenAPI) → e2e smoke.
**Чек-лист.** Happy-path + границы (qty=0, out-of-stock, конфликты версий).
**Готово когда.** Tests green в CI, покрытие критичных путей.
**Артефакты.** Фикстуры/фабрики.

---

# Этап 17 — CI/CD и окружения

**Цель.** Повторяемые сборки и безопасные релизы.
**CI.** Линт → тесты → бинарь → Docker (multi-stage, distroless/ubi-micro) → SBOM → security scan → publish.
**CD.** Dev/Staging/Prod через env; миграции → прогрев → переключение (blue-green/canary). Бэкапы + регулярные DR-тесты.
**Инфра.** A: K8s (Helm/ArgoCD, Prom+Grafana, Loki/ELK, Jaeger/Tempo). B: VM + systemd + nginx + certbot (проще).
**Готово когда.** Автодеплой на staging по merge; prod — ручное подтверждение.
**Артефакты.** `Dockerfile`, `compose.yaml`/Helm, GitHub Actions/GitLab CI.


# Этап 18 — Эксплуатация и комплаенс

**Цель.** Предсказуемые инциденты, соответствие GDPR.
**Решения.** SLO/алерты по 5xx/latency/DB/очередям; маскирование PII; privacy policy, удаление/экспорт данных.
**Чек-лист.** Runbook, on-call (если нужно), мониторинг бэкапов.
**Готово когда.** Проверка восстановления бэкапа успешна; алерты не «шумят».
**Артефакты.** Runbooks, политики, алерт-правила.

---

# Этап 19 — Документация и поддержка

**Цель.** Лёгкий вход и сопровождение.
**Артефакты.** README (dev/stage/prod), ARCHITECTURE.md, API docs (OpenAPI + примеры), CONTRIBUTING.md, STYLEGUIDE.md, ADR, Runbooks.

---

---

## Базовый набор зависимостей (резюме)

Router/MW: chi, chi/middleware, httprate, nosurf, cors
БД: pgx stdlib, golang-migrate, sqlc
Сессии/пароли: scs, argon2id
Валидация: validator v10
Логи/метрики/трейсинг: slog, promhttp, OpenTelemetry
Кэш/очереди: go-redis, asynq
Документация: oapi-codegen

---

## 
