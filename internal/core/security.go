package core

// security.go ‚Äî –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ —É—Å—Ç–∞–Ω–æ–≤–∫—É –±–µ–∑–æ–ø–∞—Å–Ω—ã—Ö HTTP-–∑–∞–≥–æ–ª–æ–≤–∫–æ–≤.
// –í–∫–ª—é—á–∞–µ—Ç Content-Security-Policy (CSP) —Å nonce, HSTS –∏ –¥—Ä—É–≥–∏–µ –º–µ—Ä—ã –∑–∞—â–∏—Ç—ã.

import (
	"github.com/gin-gonic/gin"
)

// -----------------------------------------------------------
// SecureHeaders ‚Äî middleware: CSP —Å nonce + –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏
// -----------------------------------------------------------
//
// –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –æ—Å–Ω–æ–≤–Ω—ã–µ –∑–∞—â–∏—Ç–Ω—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏:
//
//  ‚Ä¢ Content-Security-Policy (CSP) ‚Äî –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç –∏—Å—Ç–æ—á–Ω–∏–∫–∏ JS, CSS, –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π.
//  ‚Ä¢ X-Content-Type-Options: nosniff ‚Äî –±–ª–æ–∫–∏—Ä—É–µ—Ç MIME-type sniffing.
//  ‚Ä¢ X-Frame-Options: DENY ‚Äî –∑–∞–ø—Ä–µ—â–∞–µ—Ç –≤—Å—Ç—Ä–∞–∏–≤–∞–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –≤ iframe.
//  ‚Ä¢ Referrer-Policy ‚Äî —É–ø—Ä–∞–≤–ª—è–µ—Ç –ø–µ—Ä–µ–¥–∞—á–µ–π –∑–∞–≥–æ–ª–æ–≤–∫–∞ Referer.
//  ‚Ä¢ Permissions-Policy ‚Äî –∑–∞–ø—Ä–µ—â–∞–µ—Ç –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ, –º–∏–∫—Ä–æ—Ñ–æ–Ω—É, –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ –∏ —Ç.–¥.
//
// CSP –∏—Å–ø–æ–ª—å–∑—É–µ—Ç nonce (–æ–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–π –∫–ª—é—á –Ω–∞ –∫–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å), —á—Ç–æ–±—ã —Ä–∞–∑—Ä–µ—à–∏—Ç—å
// –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ —Ç–µ—Ö inline-—Å—Ç–∏–ª–µ–π/—Å–∫—Ä–∏–ø—Ç–æ–≤, —É –∫–æ—Ç–æ—Ä—ã—Ö –∞—Ç—Ä–∏–±—É—Ç nonce —Å–æ–≤–ø–∞–¥–∞–µ—Ç.

func SecureHeaders() gin.HandlerFunc {
	return func(c *gin.Context) {
		// –ò–∑–≤–ª–µ–∫–∞–µ–º nonce –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∑–∞–ø—Ä–æ—Å–∞.
		nonce, ok := c.Request.Context().Value(CtxNonce).(string)
		if !ok || nonce == "" {
			// –ï—Å–ª–∏ nonce –Ω–µ –Ω–∞–π–¥–µ–Ω ‚Äî —ç—Ç–æ –æ—à–∏–±–∫–∞ –∏ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ –Ω–µ–±–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ.
			FailC(c, Internal("Nonce –Ω–µ –Ω–∞–π–¥–µ–Ω", nil))
			return
		}

		// –§–æ—Ä–º–∏—Ä—É–µ–º Content-Security-Policy.
		// –†–∞–∑—Ä–µ—à–∞–µ–º —Ç–æ–ª—å–∫–æ:
		//   - —Å–≤–æ–∏ —Ä–µ—Å—É—Ä—Å—ã ('self')
		//   - data: –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –∏ —à—Ä–∏—Ñ—Ç–æ–≤
		//   - jsdelivr.net –¥–ª—è –≤–Ω–µ—à–Ω–∏—Ö –±–∏–±–ª–∏–æ—Ç–µ–∫ (CSS/JS/—à—Ä–∏—Ñ—Ç—ã)
		//   - –∏–Ω–ª–∞–π–Ω-—Å–∫—Ä–∏–ø—Ç—ã/—Å—Ç–∏–ª–∏ —Ç–æ–ª—å–∫–æ —Å nonce, –≤—ã–¥–∞–Ω–Ω—ã–º –¥–ª—è —ç—Ç–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞.
		csp := "default-src 'self'; " +
			"img-src 'self' data:; " + // –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ –ª–æ–∫–∞–ª—å–Ω—ã–µ –∏–ª–∏ data:
			"style-src 'self' https://cdn.jsdelivr.net 'nonce-" + nonce + "'; " + // —Å—Ç–∏–ª–∏ –∏–∑ jsdelivr –∏ —Å nonce
			"script-src 'self' https://cdn.jsdelivr.net 'nonce-" + nonce + "'; " + // JS ‚Äî –ª–æ–∫–∞–ª—å–Ω–æ, CDN, —Å nonce
			"font-src 'self' https://cdn.jsdelivr.net data:; " + // —à—Ä–∏—Ñ—Ç—ã –ª–æ–∫–∞–ª—å–Ω—ã–µ, CDN, data:
			"connect-src 'self' https://cdn.jsdelivr.net; " + // —Ä–∞–∑—Ä–µ—à–µ–Ω—ã –∑–∞–ø—Ä–æ—Å—ã –∫ jsdelivr (–Ω–∞–ø—Ä. sourcemaps)
			"form-action 'self'; " + // —Ñ–æ—Ä–º—ã –º–æ–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Ç–æ–ª—å–∫–æ –Ω–∞ —Å–≤–æ–π –¥–æ–º–µ–Ω
			"frame-ancestors 'none'; " + // –∑–∞–ø—Ä–µ—â–∞–µ–º –≤—Å—Ç—Ä–∞–∏–≤–∞–Ω–∏–µ –≤ iframe
			"base-uri 'self'" // –∑–∞–ø—Ä–µ—Ç –ø–æ–¥–º–µ–Ω—ã <base href>

		// –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.
		c.Writer.Header().Set("Content-Security-Policy", csp)

		// –ë–ª–æ–∫–∏—Ä—É–µ—Ç –ø–æ–ø—ã—Ç–∫–∏ –±—Ä–∞—É–∑–µ—Ä–∞ —É–≥–∞–¥–∞—Ç—å MIME-—Ç–∏–ø (XSS-–∑–∞—â–∏—Ç–∞).
		c.Writer.Header().Set("X-Content-Type-Options", "nosniff")

		// –ó–∞–ø—Ä–µ—â–∞–µ—Ç –≤—Å—Ç—Ä–∞–∏–≤–∞—Ç—å —Å–∞–π—Ç –≤ iframe (Clickjacking-–∑–∞—â–∏—Ç–∞).
		c.Writer.Header().Set("X-Frame-Options", "DENY")

		// –£–ø—Ä–∞–≤–ª—è–µ—Ç –ø–µ—Ä–µ–¥–∞—á–µ–π Referer: –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å—Å—è —Ç–æ–ª—å–∫–æ –¥–æ–º–µ–Ω –∏ –ø—Ä–æ—Ç–æ–∫–æ–ª.
		c.Writer.Header().Set("Referrer-Policy", "strict-origin-when-cross-origin")

		// –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç –¥–æ—Å—Ç—É–ø –∫ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–º –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è–º –±—Ä–∞—É–∑–µ—Ä–∞.
		c.Writer.Header().Set("Permissions-Policy",
			"camera=(), microphone=(), geolocation=(), payment=()")

		// –ü–µ—Ä–µ–¥–∞—ë–º —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–∞–ª—å—à–µ.
		c.Next()
	}
}

// -----------------------------------------------------------
// HSTS ‚Äî –≤–∫–ª—é—á–∞–µ—Ç Strict-Transport-Security –¥–ª—è HTTPS
// -----------------------------------------------------------
//
// HSTS (HTTP Strict Transport Security) –∑–∞—Å—Ç–∞–≤–ª—è–µ—Ç –±—Ä–∞—É–∑–µ—Ä –≤—Å–µ–≥–¥–∞
// –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å HTTPS –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö –Ω–∞ –¥–æ–º–µ–Ω.
//
//  ‚Ä¢ –†–∞–±–æ—Ç–∞–µ—Ç –¢–û–õ–¨–ö–û –ø—Ä–∏ secure-—Ä–µ–∂–∏–º–µ (–≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ).
//  ‚Ä¢ "max-age=31536000" ‚Äî –±—Ä–∞—É–∑–µ—Ä –±—É–¥–µ—Ç –ø–æ–º–Ω–∏—Ç—å –ø—Ä–∞–≤–∏–ª–æ 1 –≥–æ–¥.
//  ‚Ä¢ "includeSubDomains" ‚Äî –ø—Ä–∞–≤–∏–ª–æ —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω—è–µ—Ç—Å—è –Ω–∞ –ø–æ–¥–¥–æ–º–µ–Ω—ã.
//
// –ü—Ä–∏ dev-—Ä–µ–∂–∏–º–µ (–±–µ–∑ HTTPS) —ç—Ç–æ—Ç –∑–∞–≥–æ–ª–æ–≤–æ–∫ –Ω–µ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è,
// —á—Ç–æ–±—ã –Ω–µ –º–µ—à–∞—Ç—å –ª–æ–∫–∞–ª—å–Ω–æ–π –æ—Ç–ª–∞–¥–∫–µ.

func HSTS(isProduction bool) gin.HandlerFunc {
	return func(c *gin.Context) {
		if !isProduction {
			// –í —Ä–µ–∂–∏–º–µ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –¥–æ–±–∞–≤–ª—è–µ–º.
			c.Next()
			return
		}

		// –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º HSTS —Ç–æ–ª—å–∫–æ –ø—Ä–∏ HTTPS –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ.
		c.Writer.Header().Set(
			"Strict-Transport-Security",
			"max-age=31536000; includeSubDomains",
		)

		c.Next()
	}
}

/*

### üß† –ö—Ä–∞—Ç–∫–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ, –∑–∞—á–µ–º –Ω—É–∂–Ω—ã —ç—Ç–∏ –∑–∞–≥–æ–ª–æ–≤–∫–∏

| –ó–∞–≥–æ–ª–æ–≤–æ–∫                            | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ                                                      | –ü—Ä–∏–º–µ—Ä –∑–Ω–∞—á–µ–Ω–∏—è                                                                 |
| ------------------------------------ | --------------------------------------------------------------- | ------------------------------------------------------------------------------- |
| **Content-Security-Policy**          | –ö–æ–Ω—Ç—Ä–æ–ª—å —Ä–∞–∑—Ä–µ—à—ë–Ω–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ (CSS, JS, –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è) | `"default-src 'self'; script-src 'self' https://cdn.jsdelivr.net 'nonce-XYZ';"` |
| **X-Content-Type-Options**           | –ó–∞–ø—Ä–µ—â–∞–µ—Ç MIME type sniffing (XSS-–∑–∞—â–∏—Ç–∞)                       | `"nosniff"`                                                                     |
| **X-Frame-Options**                  | –ó–∞–ø—Ä–µ—â–∞–µ—Ç –≤—Å—Ç—Ä–∞–∏–≤–∞–Ω–∏–µ —Å–∞–π—Ç–∞ –≤ iframe                            | `"DENY"`                                                                        |
| **Referrer-Policy**                  | –£–ø—Ä–∞–≤–ª—è–µ—Ç, —á—Ç–æ –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è –≤ Referer –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–∞—Ö               | `"strict-origin-when-cross-origin"`                                             |
| **Permissions-Policy**               | –ó–∞–ø—Ä–µ—â–∞–µ—Ç –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ, –º–∏–∫—Ä–æ—Ñ–æ–Ω—É, –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏                | `"camera=(), microphone=(), geolocation=()"`                                    |
| **Strict-Transport-Security (HSTS)** | –û–±—è–∑—ã–≤–∞–µ—Ç –±—Ä–∞—É–∑–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å HTTPS                            | `"max-age=31536000; includeSubDomains"`                                         |

*/
